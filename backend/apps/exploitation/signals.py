"""
Exploitation Signals
backend/apps/exploitation/signals.py
"""

from django.db.models.signals import post_save, pre_save
from django.dispatch import receiver
from django.utils import timezone
from .models import ExploitationSession, ExploitResult

@receiver(pre_save, sender=ExploitationSession)
def update_completion_time(sender, instance, **kwargs):
    """Update completion time when status changes to completed states"""
    if instance.status in ['successful', 'failed', 'blocked', 'timeout']:
        if not instance.completed_at:
            instance.completed_at = timezone.now()

@receiver(post_save, sender=ExploitResult)
def update_session_status(sender, instance, created, **kwargs):
    """Update session status based on exploit results"""
    if created:
        session = instance.session
        if instance.success and session.status == 'in_progress':
            session.status = 'successful'
            session.save()